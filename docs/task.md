# i18n-x 国际化工具优化任务清单

根据 issues.md 中的问题分析，我们需要对 i18n-x 工具进行以下优化。每个任务都包含场景描述、问题分析、修改建议和验证方法。

## 任务1：修复自动导入换行问题

**场景**: 所有文件类型（JSX、TS、JS），自动导入功能启用时

**问题**: 
- 自动导入的 import 语句没有换行，直接跟在现有代码后面
- 例如：`import React from 'react';import { useTranslation } from 'react-i18next';const { $t1 } = useTranslation();`

**修改文件**: `src/utils/import-manager.ts`

**修改建议**:
- 修改 `addEmptyLineAfterImport` 函数，确保在添加 import 语句后正确添加换行符
- 检查 `addImportToAST` 函数中的插入逻辑

**验证方法**: 
- 执行 `npm run extract` 命令
- 检查产物文件中 import 语句是否有正确的换行和空行

## 任务2：修复模板字符串中的中文未被替换问题

**场景**: 模板字符串语法，如 `请求接口${api}失败: ${code}`

**问题**:
- 模板字符串中的中文字符串未被正确替换
- 特别是在函数内部使用的模板字符串，如 `test()` 函数中的错误信息

**修改文件**: `src/ast/index.ts` 中的 `TemplateLiteral` 处理逻辑

**修改建议**:
- 增强 `TemplateLiteral` 访问器，确保能处理各种嵌套情况下的模板字符串
- 特别关注函数内部的模板字符串处理

**验证方法**:
- 执行 `npm run extract` 命令
- 检查 `test/temp/test/demo/jsx/jsx-basic.jsx` 和 `test/temp/test/demo/typescript/throw-error.ts` 中的模板字符串是否被正确替换

## 任务3：修复 JSX 表达式容器中的字符串字面量未被替换问题

**场景**: JSX 文件，表达式容器语法，如 `{true && '条件渲染的文本'}`

**问题**:
- JSX 表达式容器中的条件渲染文本未被替换
- 例如：`{true && '条件渲染的文本'}` 和 `{false || '逻辑或的文本'}`

**修改文件**: `src/ast/index.ts` 中的 `JSXExpressionContainer` 处理逻辑

**修改建议**:
- 增强 `JSXExpressionContainer` 访问器，处理逻辑表达式中的字符串字面量
- 添加对 `LogicalExpression` 节点类型的支持

**验证方法**:
- 执行 `npm run extract` 命令
- 检查 `test/temp/test/demo/jsx/jsx-basic.jsx` 中的表达式容器是否被正确替换

## 任务4：修复代码格式变化问题

**场景**: 所有文件类型，特别是 JSX 代码块

**问题**:
- 处理后代码缩进和格式发生变化，影响可读性
- 特别是在 JSX 代码块中，原本格式良好的代码变得难以阅读

**修改文件**: `src/ast/index.ts` 中的代码生成逻辑

**修改建议**:
- 修改代码生成配置，保持原有的缩进和换行
- 可以在 `generate` 函数调用时添加格式保持选项

**验证方法**:
- 执行 `npm run extract` 命令
- 对比产物文件的格式是否与原始文件一致

## 任务5：修复多余空行问题

**场景**: 所有文件类型，特别是对象定义和数组定义

**问题**:
- 处理后出现大量多余空行，影响代码紧凑性
- 特别是在 `addRandomNotification` 方法中的 messages 对象定义

**修改文件**: `src/ast/index.ts` 中的代码生成逻辑

**修改建议**:
- 修改代码生成配置，控制空行数量
- 可以设置 `compact` 或其他相关选项

**验证方法**:
- 执行 `npm run extract` 命令
- 检查产物文件中是否有多余空行

## 任务6：修复模板字符串被转换为字符串拼接的问题

**场景**: 复杂模板字符串，如 HTML 模板

**问题**:
- 模板字符串被转换为难以阅读的字符串拼接形式
- 特别是在 `renderTodoList` 函数中的 HTML 模板

**修改文件**: `src/ast/index.ts` 中的 `TemplateLiteral` 处理逻辑

**修改建议**:
- 修改模板字符串处理逻辑，尽量保持模板字符串结构
- 对于复杂的 HTML 模板，考虑特殊处理方式

**验证方法**:
- 执行 `npm run extract` 命令
- 检查 `renderTodoList` 函数中的模板字符串是否保持了可读性

## 任务7：修复特殊字符处理问题

**场景**: 包含转义字符的字符串

**问题**:
- 转义字符处理不正确，如 `guo_l\xFC_tong_zhi_lei_xing`
- 可能导致生成的代码无法正确运行

**修改文件**: `src/gen-key-value.ts` 中的 key 生成逻辑

**修改建议**:
- 修改特殊字符处理逻辑，确保转义字符被正确处理
- 考虑使用 Unicode 转换函数

**验证方法**:
- 执行 `npm run extract` 命令
- 检查产物文件中特殊字符是否正确处理

## 任务8：修复同一文件中相同函数处理不一致的问题

**场景**: 包含重复函数定义的文件

**问题**:
- 同一文件中相同的函数定义被采用不同的替换策略
- 例如 `test/demo/jsx/jsx-basic.jsx` 中的两个 `renderTodoList` 函数处理方式不同

**修改文件**: `src/ast/index.ts` 中的处理逻辑

**修改建议**:
- 增强函数处理逻辑，确保对相同函数使用一致的替换策略
- 考虑使用缓存机制记录已处理的函数

**验证方法**:
- 执行 `npm run extract` 命令
- 检查同一文件中相同函数是否采用一致的替换策略

## 任务优先级

1. **高优先级**: 任务1、任务2、任务3（核心功能问题）
2. **中优先级**: 任务4、任务5、任务6（格式和可读性问题）
3. **低优先级**: 任务7、任务8（特殊情况和一致性问题）

## 验证流程

每个任务完成后，都需要：
1. 执行 `npm run extract` 命令
2. 对比 `test/demo/` 和 `test/temp/test/demo/` 目录中的对应文件
3. 检查问题是否已解决
4. 确保没有引入新的问题

这些任务都是基于最小改动原则设计的，主要修改现有的处理逻辑，不会大幅改变项目架构。每个任务都可以独立执行和验证，确保优化效果。 